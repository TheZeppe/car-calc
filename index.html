<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        
        .table-sticky-column {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 20;
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; margin: 0; }
            .print-shadow-none { box-shadow: none !important; border: none !important; }
            .max-w-screen-print { max-width: 100% !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .table-sticky-column { position: static !important; box-shadow: none !important; }
            .rounded-3xl { border-radius: 0 !important; }
        }

        .banner-container {
            position: relative;
            min-height: 400px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4rem;
            color: white;
            transition: background-color 0.3s ease, min-height 0.2s ease;
        }

        .banner-bg-image {
            position: absolute;
            right: 0;
            top: 0;
            width: 80%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            mask-image: linear-gradient(to left, rgba(0,0,0,1) 85%, rgba(0,0,0,0));
            -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 85%, rgba(0,0,0,0));
            transition: object-position 0.2s ease;
        }

        .banner-content { position: relative; z-index: 10; max-width: 60%; }
        .editable-text:hover { background: rgba(255,255,255,0.1); cursor: pointer; border-radius: 8px; }
        .interest-table input { width: 55px; text-align: center; font-size: 11px; padding: 4px; border: 1px solid #e2e8f0; border-radius: 4px; background: #f8fafc; }
        
        .config-label { font-size: 10px; font-weight: bold; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .footer-avatar { object-fit: cover; border: 4px solid #fff; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); transition: all 0.3s ease; }
        .qr-code-frame { border: 2px dashed #cbd5e1; padding: 2px; background: white; transition: all 0.3s ease; line-height: 0; }
        
        #loadingOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 pb-20">

    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4"></div>
        <p class="text-xl font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...</p>
        <p class="text-sm opacity-80 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á</p>
    </div>

    <div class="max-w-[98%] mx-auto py-4 md:py-8 max-w-screen-print">
        
        <!-- Admin Controls -->
        <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200 mb-6 no-print">
            <div class="flex flex-col gap-6">
                <div class="flex flex-col xl:flex-row gap-6">
                    <!-- Interest Table -->
                    <div class="flex-1 bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h2 class="text-sm font-bold text-slate-700 flex items-center gap-2 mb-4">
                            <span class="w-2 h-4 bg-blue-600 rounded"></span>
                            ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Å‡∏•‡∏≤‡∏á (MASTER RATES)
                        </h2>
                        <div class="overflow-x-auto custom-scrollbar bg-white p-2 rounded-lg border border-slate-100 shadow-sm">
                            <table class="w-full text-[11px] interest-table">
                                <thead>
                                    <tr class="text-slate-400 border-b">
                                        <th class="pb-2 text-left">‡∏î‡∏≤‡∏ß‡∏ô‡πå (%)</th>
                                        <th class="pb-2 text-center">24</th>
                                        <th class="pb-2 text-center">36</th>
                                        <th class="pb-2 text-center">48</th>
                                        <th class="pb-2 text-center">60</th>
                                        <th class="pb-2 text-center">72</th>
                                        <th class="pb-2 text-center">84</th>
                                        <th class="pb-2 text-center">96</th>
                                        <th class="pb-2 text-center">108</th>
                                    </tr>
                                </thead>
                                <tbody id="masterInterestBody" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Layout & Theme & Save Options -->
                    <div class="w-full xl:w-1/3 flex flex-col gap-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="config-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</span>
                                <select id="carCountSelect" class="w-full bg-slate-50 p-2 rounded text-sm border border-slate-200"></select>
                            </div>
                            <div>
                                <span class="config-label text-blue-600">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</span>
                                <input type="color" id="bannerColorPicker" value="#1e40af" oninput="updateBannerColor(this.value)" class="h-10 w-full cursor-pointer rounded border border-slate-200 p-1 bg-white">
                            </div>
                        </div>
                        <div>
                            <span class="config-label">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</span>
                            <div id="termVisibility" class="flex flex-wrap gap-2 mt-1"></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-auto">
                            <button onclick="window.print()" class="col-span-2 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-md flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 00-2 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF
                            </button>
                            <button onclick="exportAsImage('png')" class="bg-emerald-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition shadow-sm">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô .PNG
                            </button>
                            <button onclick="exportAsImage('jpg')" class="bg-amber-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-amber-700 transition shadow-sm">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô .JPG
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Styling Controls -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 border-t pt-6">
                    <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 grid grid-cols-2 gap-4 h-fit">
                        <div class="col-span-2"><span class="config-label text-blue-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</span><input type="text" id="inputSellerName" value="‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ (‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢)" oninput="updateFooter()" class="w-full text-xs p-2 rounded border border-blue-200"></div>
                        <div><span class="config-label text-blue-600">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span><input type="text" id="inputSellerPhone" value="081-234-5678" oninput="updateFooter()" class="w-full text-xs p-2 rounded border border-blue-200"></div>
                        <div><span class="config-label text-blue-600">LINE ID</span><input type="text" id="inputSellerLine" value="car_sales_pro" oninput="updateFooter()" class="w-full text-xs p-2 rounded border border-blue-200"></div>
                        <div class="col-span-2"><span class="config-label text-blue-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (*) ‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á</span><input type="text" id="inputDisclaimer" value="* ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô" oninput="updateFooter()" class="w-full text-xs p-2 rounded border border-blue-200"></div>
                    </div>

                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-inner grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="col-span-full border-b pb-1 mb-1 flex justify-between items-center">
                            <span class="text-[10px] font-bold text-blue-500">‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î (IMAGE & LAYOUT ADJUST)</span>
                        </div>
                        
                        <div class="col-span-full grid grid-cols-3 gap-4 bg-slate-50 p-3 rounded-lg mb-2">
                            <div>
                                <span class="config-label text-purple-600 font-bold">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏£‡∏ñ (X)</span>
                                <input type="range" id="posCarX" min="0" max="100" value="50" oninput="applyStyles()" class="w-full h-1.5 bg-purple-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <span class="config-label text-red-600 font-bold">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á Header</span>
                                <input type="range" id="sizeBannerHeight" min="200" max="1000" value="400" oninput="applyStyles()" class="w-full h-1.5 bg-red-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                            <div>
                                <span class="config-label text-purple-600 font-bold">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏•‡πå (Y)</span>
                                <input type="range" id="posAvatarY" min="0" max="100" value="50" oninput="applyStyles()" class="w-full h-1.5 bg-purple-200 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>

                        <div>
                            <span class="config-label">‡∏Ç‡∏ô‡∏≤‡∏î Font ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á</span>
                            <input type="range" id="sizeTableHead" min="8" max="18" value="10" oninput="renderTable()" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <span class="config-label">‡∏Ç‡∏ô‡∏≤‡∏î Font ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤</span>
                            <input type="range" id="sizeTableData" min="10" max="22" value="13" oninput="renderTable()" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <span class="config-label text-red-600">‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏•‡πå</span>
                            <input type="range" id="sizeAvatar" min="60" max="250" value="160" oninput="applyStyles()" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <span class="config-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</span>
                            <select id="weightTableData" onchange="renderTable()" class="w-full text-[10px] p-1 border rounded">
                                <option value="300">‡∏ö‡∏≤‡∏á</option>
                                <option value="400" selected>‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                <option value="600">‡∏´‡∏ô‡∏≤</option>
                            </select>
                        </div>
                        <div>
                            <span class="config-label">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á</span>
                            <input type="color" id="colorHeadBg" value="#f8fafc" oninput="renderTable()" class="h-8 w-full cursor-pointer rounded">
                        </div>
                        <div>
                            <span class="config-label text-green-600">QR Code (‡∏Ç‡∏¢‡∏≤‡∏¢)</span>
                            <input type="range" id="sizeQR" min="50" max="225" value="135" oninput="applyStyles()" class="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>

                <div id="inputGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar border-t pt-4"></div>
            </div>
        </div>

        <!-- PREVIEW AREA -->
        <div id="captureArea" class="bg-white rounded-3xl shadow-2xl border border-slate-200 overflow-hidden print-shadow-none">
            
            <!-- Banner -->
            <div id="tableBanner" class="banner-container" style="background-color: #1e40af;">
                <img id="carPreview" src="https://images.unsplash.com/photo-1552519507-da3b142c6e3d?q=80&w=1000&auto=format&fit=crop" class="banner-bg-image opacity-80" alt="Car Preview" style="object-position: 50% center;">
                <div class="banner-content">
                    <span class="inline-block px-5 py-2 bg-white/20 rounded-full text-[12px] font-bold uppercase tracking-widest mb-8 backdrop-blur-sm">Exclusive Promotion</span>
                    <h2 id="displayModel" contenteditable="true" class="font-extrabold mb-4 editable-text leading-none" style="font-size: 82px; color: white;">All-New Model</h2>
                    <p id="displaySlogan" contenteditable="true" class="text-2xl opacity-90 font-light italic editable-text">"‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"</p>
                </div>
                <label class="absolute bottom-10 right-10 bg-white/10 hover:bg-white/30 p-3.5 rounded-2xl cursor-pointer transition no-print backdrop-blur-md border border-white/20">
                    <span class="text-[12px] font-bold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</span>
                    <input type="file" id="bannerImgInput" class="hidden" accept="image/*">
                </label>
            </div>
            
            <!-- Table Content -->
            <div class="overflow-x-auto custom-scrollbar bg-white">
                <table class="w-full border-collapse">
                    <thead id="tableHeader">
                        <tr id="tableHeaderRow" class="tracking-wider font-bold"></tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
            
            <!-- Footer -->
            <div id="footerSection" class="px-8 py-6 md:px-12 md:py-8 bg-slate-50 border-t flex flex-nowrap items-center justify-between gap-4 overflow-hidden" style="min-height: 220px;">
                <div class="flex items-center gap-8 shrink-0">
                    <div class="relative group">
                        <img id="sellerAvatar" src="https://images.unsplash.com/photo-1560250097-0b93528c311a?q=80&w=400&auto=format&fit=crop" class="footer-avatar" alt="Seller" style="width: 160px; height: 160px; border-radius: 50%; object-position: center 50%;">
                        <label class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition no-print" id="avatarLabel" style="border-radius: 50%;">
                            <span class="text-[10px] text-white font-bold bg-black/50 px-2 py-1 rounded">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</span>
                            <input type="file" id="avatarImgInput" class="hidden" accept="image/*">
                        </label>
                    </div>
                    <div id="footerTextStyle">
                        <div id="displaySellerName" class="text-2xl font-extrabold mb-2">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ (‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢)</div>
                        <div class="flex flex-col gap-2 opacity-90">
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px]">üìû</span>
                                <span id="displaySellerPhone" class="font-bold">081-234-5678</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-6 h-6 rounded-full bg-green-600 text-white flex items-center justify-center text-[10px]">L</span>
                                <span>LINE ID: <span id="displaySellerLine" class="font-bold">car_sales_pro</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-6 self-center h-full">
                    <div class="text-right flex flex-col items-end justify-center h-full max-w-[220px]">
                        <div id="displayDisclaimer" class="text-[10px] italic opacity-50 leading-tight mb-4"></div>
                        <div class="font-bold opacity-20 uppercase tracking-[0.2em] text-[8px]">Professional Quote System</div>
                    </div>
                    <div class="flex flex-col items-center justify-center shrink-0">
                        <div class="relative group qr-code-frame">
                            <img id="sellerQR" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='%23cbd5e1' stroke-width='1'%3E%3Crect width='18' height='18' x='3' y='3' rx='2'/%3E%3Cpath d='M7 7h.01M17 7h.01M7 17h.01M17 17h.01M12 12h.01'/%3E%3C/svg%3E" class="bg-white" style="width: 135px; height: 135px;" alt="QR Code">
                            <label class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition no-print">
                                <span class="text-[9px] text-white font-bold bg-black/50 px-2 py-1 rounded">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î QR</span>
                                <input type="file" id="qrImgInput" class="hidden" accept="image/*">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const terms = [24, 36, 48, 60, 72, 84, 96, 108];
        const downTiers = [0, 5, 10, 15, 20, 25, 30, 40, 50]; 
        
        let activeTerms = [48, 60, 72, 84]; 
        let masterRates = {}; 
        let cars = Array.from({ length: 14 }, (_, i) => ({
            id: i,
            model: i === 0 ? "Toyota Hilux Revo Z-Edition" : `‡∏£‡∏∏‡πà‡∏ô‡∏¢‡πà‡∏≠‡∏¢ ${i+1}`,
            price: i === 0 ? 699000 : 800000,
            downPercents: "0, 10, 15, 25"
        }));
        let activeCount = 2;

        function init() {
            downTiers.forEach(d => { terms.forEach(t => { masterRates[`${d}_${t}`] = 2.49; }); });
            
            const countSelect = document.getElementById('carCountSelect');
            for(let i=1; i<=14; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.text = `${i} ‡∏£‡∏∏‡πà‡∏ô`;
                if(i === activeCount) opt.selected = true;
                countSelect.appendChild(opt);
            }
            
            const termContainer = document.getElementById('termVisibility');
            terms.forEach(t => {
                const label = document.createElement('label');
                label.className = "flex items-center gap-2 text-[10px] cursor-pointer bg-white px-2 py-1 rounded-lg border border-slate-200";
                const isChecked = activeTerms.includes(t) ? 'checked' : '';
                label.innerHTML = `<input type="checkbox" value="${t}" ${isChecked} onchange="toggleTerm(${t})"> <span>${t}‡∏á‡∏ß‡∏î</span>`;
                termContainer.appendChild(label);
            });

            document.getElementById('bannerImgInput').onchange = (e) => handleFileSelect(e, 'carPreview');
            document.getElementById('avatarImgInput').onchange = (e) => handleFileSelect(e, 'sellerAvatar');
            document.getElementById('qrImgInput').onchange = (e) => handleFileSelect(e, 'sellerQR');

            renderMasterRates();
            renderInputs();
            renderTable();
            updateFooter();
            applyStyles();
        }

        async function exportAsImage(format) {
            const overlay = document.getElementById('loadingOverlay');
            const captureArea = document.getElementById('captureArea');
            overlay.style.display = 'flex';

            try {
                // Pre-process for high quality capture
                const stickyCols = document.querySelectorAll('.table-sticky-column');
                stickyCols.forEach(col => col.style.position = 'static');

                // Generate Canvas with extra settings for reliability
                const canvas = await html2canvas(captureArea, {
                    scale: 2.5, // ‡∏ö‡∏≤‡∏•‡∏≤‡∏ô‡∏ã‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: true,
                    allowTaint: false,
                    onclone: (clonedDoc) => {
                        // Ensure cloned elements are visible
                        const clonedArea = clonedDoc.getElementById('captureArea');
                        clonedArea.style.borderRadius = '0';
                    }
                });

                stickyCols.forEach(col => col.style.position = 'sticky');

                const fileExt = format === 'png' ? 'png' : 'jpg';
                const mimeType = format === 'png' ? 'image/png' : 'image/jpeg';
                const dataUrl = canvas.toDataURL(mimeType, 0.92);
                const fileName = `Car_Quote_${new Date().getTime()}.${fileExt}`;

                // Force Trigger Download
                const link = document.createElement('a');
                link.style.display = 'none';
                link.href = dataUrl;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                
                // Backup: if link click doesn't work (iOS Safari), open in new tab
                setTimeout(() => {
                    document.body.removeChild(link);
                    overlay.style.display = 'none';
                }, 100);

            } catch (err) {
                console.error("Export error:", err);
                overlay.style.display = 'none';
                alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢! ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
            }
        }

        function handleFileSelect(e, targetId) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    document.getElementById(targetId).src = ev.target.result;
                    setTimeout(renderTable, 100);
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleTerm(t) {
            if (activeTerms.includes(t)) activeTerms = activeTerms.filter(item => item !== t);
            else { activeTerms.push(t); activeTerms.sort((a, b) => a - b); }
            renderTable();
        }

        function updateBannerColor(val) {
            document.getElementById('tableBanner').style.backgroundColor = val;
        }

        function renderMasterRates() {
            const body = document.getElementById('masterInterestBody');
            body.innerHTML = '';
            downTiers.forEach(tier => {
                let rowHTML = `<td class="py-1 font-bold text-slate-400 pr-2">${tier}%</td>`;
                terms.forEach(term => {
                    const key = `${tier}_${term}`;
                    rowHTML += `<td class="text-center"><input type="number" step="0.01" value="${masterRates[key]}" oninput="masterRates['${key}']=parseFloat(this.value||0); renderTable();"></td>`;
                });
                const tr = document.createElement('tr');
                tr.innerHTML = rowHTML;
                body.appendChild(tr);
            });
        }

        function renderInputs() {
            const grid = document.getElementById('inputGrid');
            grid.innerHTML = '';
            for(let i=0; i<activeCount; i++) {
                const car = cars[i];
                const card = document.createElement('div');
                card.className = "bg-white p-3 rounded-xl border border-slate-200 h-fit shadow-sm";
                card.innerHTML = `
                    <div class="mb-2"><span class="config-label">‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ #${i+1}</span><input type="text" value="${car.model}" oninput="updateCar(${i}, 'model', this.value)" class="w-full text-xs font-bold border-b border-slate-100 pb-1 outline-none focus:border-blue-400"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><span class="config-label">‡∏£‡∏≤‡∏Ñ‡∏≤</span><input type="number" value="${car.price}" oninput="updateCar(${i}, 'price', this.value)" class="w-full text-xs p-1.5 bg-slate-50 rounded border border-transparent focus:border-blue-200 outline-none"></div>
                        <div><span class="config-label">‡∏î‡∏≤‡∏ß‡∏ô‡πå (%)</span><input type="text" value="${car.downPercents}" oninput="updateCar(${i}, 'downPercents', this.value)" class="w-full text-xs p-1.5 bg-slate-50 rounded border border-transparent focus:border-blue-200 outline-none"></div>
                    </div>
                `;
                grid.appendChild(card);
            }
        }

        function getRateForDown(downPercent, term) {
            const applicableTier = [...downTiers].reverse().find(tier => downPercent >= tier) || 0;
            return masterRates[`${applicableTier}_${term}`] || 0;
        }

        function updateFooter() {
            document.getElementById('displaySellerName').innerText = document.getElementById('inputSellerName').value;
            document.getElementById('displaySellerPhone').innerText = document.getElementById('inputSellerPhone').value;
            document.getElementById('displaySellerLine').innerText = document.getElementById('inputSellerLine').value;
            document.getElementById('displayDisclaimer').innerText = document.getElementById('inputDisclaimer').value;
        }

        function applyStyles() {
            const bannerHeightValue = document.getElementById('sizeBannerHeight').value;
            const banner = document.getElementById('tableBanner');
            banner.style.minHeight = bannerHeightValue + 'px';
            
            const titleSize = Math.max(40, Math.min(100, bannerHeightValue / 5)) + 'px';
            document.getElementById('displayModel').style.fontSize = titleSize;

            const avatar = document.getElementById('sellerAvatar');
            const avatarSize = document.getElementById('sizeAvatar').value + 'px';
            avatar.style.width = avatarSize;
            avatar.style.height = avatarSize;

            const qr = document.getElementById('sellerQR');
            const qrSize = document.getElementById('sizeQR').value + 'px';
            qr.style.width = qrSize;
            qr.style.height = qrSize;

            const carX = document.getElementById('posCarX').value + '%';
            document.getElementById('carPreview').style.objectPosition = `${carX} center`;

            const avatarY = document.getElementById('posAvatarY').value + '%';
            avatar.style.objectPosition = `center ${avatarY}`;

            renderTable(); 
        }

        function renderTable() {
            const headRow = document.getElementById('tableHeaderRow');
            const body = document.getElementById('tableBody');
            
            const sizeH = document.getElementById('sizeTableHead').value + 'px';
            const sizeD = document.getElementById('sizeTableData').value + 'px';
            const weightD = document.getElementById('weightTableData').value;
            const colorBg = document.getElementById('colorHeadBg').value;
            
            let headHTML = `<th class="p-4 text-left table-sticky-column border-r min-w-[200px]" style="background-color:${colorBg}; font-size:${sizeH}">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏∏‡πà‡∏ô</th>
                            <th class="p-4 text-right" style="background-color:${colorBg}; font-size:${sizeH}">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                            <th class="p-4 text-center" style="background-color:${colorBg}; font-size:${sizeH}">‡∏î‡∏≤‡∏ß‡∏ô‡πå</th>
                            <th class="p-4 text-right" style="background-color:${colorBg}; font-size:${sizeH}">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå</th>
                            <th class="p-4 text-right border-r" style="background-color:${colorBg}; font-size:${sizeH}">‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î</th>`;
            
            activeTerms.forEach(t => { 
                headHTML += `<th class="p-4 text-right" style="background-color:${colorBg}; font-size:${sizeH}">${t} ‡∏á‡∏ß‡∏î</th>`; 
            });
            headRow.innerHTML = headHTML;

            body.innerHTML = '';
            for(let i=0; i<activeCount; i++) {
                const car = cars[i];
                const downList = car.downPercents.split(',').map(d => parseFloat(d.trim())).filter(d => !isNaN(d));
                downList.forEach((downP, index) => {
                    const downAmt = car.price * (downP / 100);
                    const loanAmt = car.price - downAmt;
                    const tr = document.createElement('tr');
                    tr.style.fontWeight = weightD;
                    
                    if (index === 0 && i !== 0) tr.classList.add('border-t-4', 'border-slate-100');
                    
                    let html = index === 0 ? `<td class="p-4 table-sticky-column border-r align-top bg-white font-bold" rowspan="${downList.length}" style="font-size:${sizeD}">${car.model}</td><td class="p-4 text-right font-bold align-top bg-white" rowspan="${downList.length}" style="font-size:${sizeD}">${formatCurrency(car.price)}</td>` : '';
                    
                    html += `<td class="p-4 text-center text-slate-400 font-bold" style="font-size:${sizeD}">${downP}%</td>
                             <td class="p-4 text-right text-slate-500" style="font-size:${sizeD}">${formatCurrency(downAmt)}</td>
                             <td class="p-4 text-right font-bold border-r text-blue-600" style="font-size:${sizeD}">${formatCurrency(loanAmt)}</td>`;
                    
                    activeTerms.forEach(t => {
                        const rate = getRateForDown(downP, t);
                        const monthly = (loanAmt + (loanAmt * (rate/100) * (t/12))) / t;
                        html += `<td class="p-4 text-right font-extrabold text-slate-900" style="font-size:${sizeD}">${formatCurrency(monthly)}</td>`;
                    });
                    
                    tr.innerHTML = html;
                    body.appendChild(tr);
                });
            }
        }

        function updateCar(idx, field, val) {
            cars[idx][field] = (field === 'model' || field === 'downPercents') ? val : parseFloat(val || 0);
            renderTable();
        }
        function formatCurrency(n) { return new Intl.NumberFormat('th-TH').format(Math.round(n)); }
        window.onload = init;
        document.getElementById('carCountSelect').onchange = (e) => { activeCount = parseInt(e.target.value); renderInputs(); renderTable(); };
    </script>
</body>
</html>

