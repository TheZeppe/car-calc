<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Export */
        .capture-table { border-collapse: collapse !important; width: 100% !important; table-layout: fixed !important; border: none !important; }
        .capture-table th, .capture-table td { border: 1px solid #e2e8f0 !important; overflow: hidden; word-wrap: break-word; }

        .table-sticky-column {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 20;
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
        }

        @media print {
            .no-print { display: none !important; }
            .table-sticky-column { position: static !important; box-shadow: none !important; }
        }

        .banner-container {
            position: relative;
            min-height: 400px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4rem;
            color: white;
        }

        .banner-bg-image {
            position: absolute;
            right: 0;
            top: 0;
            width: 80%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            mask-image: linear-gradient(to left, rgba(0,0,0,1) 85%, rgba(0,0,0,0));
            -webkit-mask-image: linear-gradient(to left, rgba(0,0,0,1) 85%, rgba(0,0,0,0));
        }

        .banner-content { position: relative; z-index: 10; max-width: 60%; }
        .editable-text:hover { background: rgba(255,255,255,0.1); cursor: pointer; border-radius: 8px; }
        .interest-table input { width: 45px; text-align: center; font-size: 10px; padding: 2px; border: 1px solid #e2e8f0; border-radius: 3px; background: #f8fafc; }
        
        .config-label { font-size: 10px; font-weight: bold; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 2px; }
        .footer-avatar { object-fit: cover; border: 4px solid #fff; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }
        .qr-code-frame { border: 2px dashed #cbd5e1; padding: 2px; background: white; line-height: 0; }
        
        #loadingOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 pb-20">

    <div id="loadingOverlay">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mb-4"></div>
        <p class="text-xl font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û...</p>
        <p class="text-sm opacity-70 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á</p>
    </div>

    <div class="max-w-[98%] mx-auto py-4 md:py-8">
        
        <!-- ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (‡∏ñ‡∏≠‡∏î‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å 14:17) -->
        <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200 mb-6 no-print">
            <div class="flex flex-col gap-6">
                <div class="flex flex-col xl:flex-row gap-6">
                    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Å‡∏•‡∏≤‡∏á (‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 24-108 ‡∏á‡∏ß‡∏î ‡πÅ‡∏•‡∏∞ ‡∏î‡∏≤‡∏ß‡∏ô‡πå 0-50%) -->
                    <div class="flex-1 bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <h2 class="text-sm font-bold text-slate-700 flex items-center gap-2 mb-4">
                            <span class="w-2 h-4 bg-blue-600 rounded"></span>
                            ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Å‡∏•‡∏≤‡∏á (24-108 ‡∏á‡∏ß‡∏î | ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 50%)
                        </h2>
                        <div class="max-h-[300px] overflow-auto custom-scrollbar bg-white p-2 rounded-lg border border-slate-100 shadow-sm">
                            <table class="w-full text-[10px] interest-table">
                                <thead>
                                    <tr class="text-slate-400 border-b sticky top-0 bg-white">
                                        <th class="pb-2 text-left">‡∏î‡∏≤‡∏ß‡∏ô‡πå (%)</th>
                                        <th class="pb-2 text-center">24</th>
                                        <th class="pb-2 text-center">36</th>
                                        <th class="pb-2 text-center">48</th>
                                        <th class="pb-2 text-center">60</th>
                                        <th class="pb-2 text-center">72</th>
                                        <th class="pb-2 text-center">84</th>
                                        <th class="pb-2 text-center">96</th>
                                        <th class="pb-2 text-center">108</th>
                                    </tr>
                                </thead>
                                <tbody id="masterInterestBody" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏≠‡∏≤‡∏ï‡πå -->
                    <div class="w-full xl:w-1/3 flex flex-col gap-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="config-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ</span>
                                <select id="carCountSelect" class="w-full bg-slate-50 p-2 rounded text-sm border border-slate-200"></select>
                            </div>
                            <div>
                                <span class="config-label text-blue-600">‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏ö‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå</span>
                                <input type="color" id="bannerColorPicker" value="#1e40af" oninput="updateBannerColor(this.value)" class="h-10 w-full cursor-pointer rounded border border-slate-200 p-1 bg-white">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-auto">
                            <button onclick="window.print()" class="col-span-2 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow-md">‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>
                            <button onclick="exportAsImage('png')" class="bg-emerald-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-emerald-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô .PNG</button>
                            <button onclick="exportAsImage('jpg')" class="bg-amber-600 text-white py-2 rounded-lg text-xs font-bold hover:bg-amber-700 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô .JPG</button>
                        </div>
                    </div>
                </div>

                <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á 14:17) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 border-t pt-6">
                    <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100 grid grid-cols-2 gap-4 h-fit">
                        <div class="col-span-2"><span class="config-label text-blue-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</span><input type="text" id="inputSellerName" value="‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ (‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢)" oninput="updateFooter()" class="w-full text-xs p-2 rounded border border-blue-200 outline-none"></div>
                        <div><span class="config-label text-blue-600">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</span><input type="text" id="inputSellerPhone" value="081-234-5678" oninput="updateFooter()" class="w-full text-xs p-2 rounded border border-blue-200 outline-none"></div>
                        <div><span class="config-label text-blue-600">LINE ID</span><input type="text" id="inputSellerLine" value="car_sales_pro" oninput="updateFooter()" class="w-full text-xs p-2 rounded border border-blue-200 outline-none"></div>
                        <div class="col-span-2"><span class="config-label text-blue-600">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏£‡∏≤‡∏á</span><input type="text" id="inputDisclaimer" value="* ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô" oninput="updateFooter()" class="w-full text-[10px] p-2 rounded border border-blue-200 outline-none"></div>
                    </div>

                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-inner grid grid-cols-3 gap-4">
                        <div class="col-span-full border-b pb-1 mb-1 font-bold text-blue-500 text-[10px]">IMAGE & LAYOUT ADJUST (X/Y)</div>
                        <div>
                            <span class="config-label text-purple-600">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏£‡∏ñ (X)</span>
                            <input type="range" id="posCarX" min="0" max="100" value="50" oninput="applyStyles()" class="w-full">
                        </div>
                        <div>
                            <span class="config-label text-red-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á Header</span>
                            <input type="range" id="sizeBannerHeight" min="250" max="600" value="400" oninput="applyStyles()" class="w-full">
                        </div>
                        <div>
                            <span class="config-label text-purple-600">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏•‡πå (Y)</span>
                            <input type="range" id="posAvatarY" min="0" max="100" value="50" oninput="applyStyles()" class="w-full">
                        </div>
                        <div>
                            <span class="config-label">Font ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á</span>
                            <input type="range" id="sizeTableHead" min="8" max="16" value="11" oninput="renderTable()" class="w-full">
                        </div>
                        <div>
                            <span class="config-label">Font ‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î</span>
                            <input type="range" id="sizeTableData" min="10" max="20" value="13" oninput="renderTable()" class="w-full">
                        </div>
                        <div>
                            <span class="config-label text-red-600">‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÄ‡∏ã‡∏•‡∏•‡πå</span>
                            <input type="range" id="sizeAvatar" min="80" max="220" value="160" oninput="applyStyles()" class="w-full">
                        </div>
                    </div>
                </div>

                <div id="inputGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 border-t pt-4"></div>
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Export (Capture Area) -->
        <div id="captureArea" class="bg-white overflow-hidden shadow-2xl mx-auto" style="width: 1200px;">
            
            <!-- Banner (‡∏ñ‡∏≠‡∏î‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å 14:17) -->
            <div id="tableBanner" class="banner-container" style="background-color: #1e40af;">
                <img id="carPreview" src="https://images.unsplash.com/photo-1552519507-da3b142c6e3d?q=80&w=1000&auto=format&fit=crop" class="banner-bg-image opacity-80" alt="Car Preview">
                <div class="banner-content">
                    <span class="inline-block px-5 py-2 bg-white/20 rounded-full text-[12px] font-bold uppercase tracking-widest mb-8 backdrop-blur-sm">Exclusive Promotion</span>
                    <h2 id="displayModel" contenteditable="true" class="font-extrabold mb-4 editable-text leading-none" style="font-size: 80px; color: white;">All-New Model</h2>
                    <p id="displaySlogan" contenteditable="true" class="text-2xl opacity-90 font-light italic editable-text">"‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà ‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"</p>
                </div>
                <label class="absolute bottom-10 right-10 bg-white/10 hover:bg-white/30 p-3 rounded-xl cursor-pointer transition no-print backdrop-blur-md border border-white/20">
                    <span class="text-[10px] font-bold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏£‡∏ñ</span>
                    <input type="file" id="bannerImgInput" class="hidden" accept="image/*">
                </label>
            </div>
            
            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÉ‡∏ä‡πâ Standard Table ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏´‡∏•‡πà‡∏ô) -->
            <table class="capture-table">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
            
            <!-- Footer (‡∏ñ‡∏≠‡∏î‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å 14:17) -->
            <div id="footerSection" class="px-12 py-8 bg-slate-50 border-t flex items-center justify-between" style="min-height: 240px;">
                <div class="flex items-center gap-10">
                    <div class="relative">
                        <img id="sellerAvatar" src="https://images.unsplash.com/photo-1560250097-0b93528c311a?q=80&w=400" class="footer-avatar" alt="Seller" style="width: 160px; height: 160px; border-radius: 50%;">
                        <label class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 bg-black/40 cursor-pointer transition no-print" style="border-radius: 50%;">
                            <span class="text-white text-[10px]">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</span>
                            <input type="file" id="avatarImgInput" class="hidden" accept="image/*">
                        </label>
                    </div>
                    <div>
                        <div id="displaySellerName" class="text-3xl font-extrabold mb-3">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ (‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢)</div>
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-3">
                                <span class="w-6 h-6 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px]">üìû</span>
                                <span id="displaySellerPhone" class="font-bold text-xl">081-234-5678</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="w-6 h-6 rounded-full bg-green-600 text-white flex items-center justify-center text-[10px]">L</span>
                                <span class="text-xl">LINE ID: <span id="displaySellerLine" class="font-bold">car_sales_pro</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-8">
                    <div class="text-right max-w-[350px]">
                        <div id="displayDisclaimer" class="text-[10px] italic text-slate-400 mb-4">* ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏á‡∏ß‡∏î‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
                    </div>
                    <div class="qr-code-frame relative group">
                        <img id="sellerQR" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='%23cbd5e1' stroke-width='1'%3E%3Crect width='18' height='18' x='3' y='3' rx='2'/%3E%3Cpath d='M7 7h.01M17 7h.01M7 17h.01M17 17h.01'/%3E%3C/svg%3E" style="width: 110px; height: 110px;">
                        <label class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/40 cursor-pointer transition no-print">
                            <span class="text-white text-[9px]">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î QR</span>
                            <input type="file" id="qrImgInput" class="hidden" accept="image/*">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const terms = [24, 36, 48, 60, 72, 84, 96, 108]; // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏á‡∏ß‡∏î
        const downTiers = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50]; // ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏î‡∏≤‡∏ß‡∏ô‡πå
        let masterRates = {}; 
        let cars = [];
        let activeCount = 3;

        function init() {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            downTiers.forEach(d => { terms.forEach(t => { masterRates[`${d}_${t}`] = 2.49; }); });
            
            const countSelect = document.getElementById('carCountSelect');
            for(let i=1; i<=14; i++) {
                const opt = document.createElement('option');
                opt.value = i; opt.text = `${i} ‡∏£‡∏∏‡πà‡∏ô`;
                if(i === activeCount) opt.selected = true;
                countSelect.appendChild(opt);
            }

            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏ñ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
            cars = Array.from({ length: 14 }, (_, i) => ({
                id: i,
                model: i === 0 ? "Toyota Hilux Revo Z-Edition" : `‡∏£‡∏∏‡πà‡∏ô‡∏¢‡πà‡∏≠‡∏¢ ${i+1}`,
                price: 699000 + (i * 100000),
                downPercents: "10, 15, 25"
            }));

            document.getElementById('bannerImgInput').onchange = (e) => handleFileSelect(e, 'carPreview');
            document.getElementById('avatarImgInput').onchange = (e) => handleFileSelect(e, 'sellerAvatar');
            document.getElementById('qrImgInput').onchange = (e) => handleFileSelect(e, 'sellerQR');

            renderMasterRates();
            renderInputs();
            renderTable();
            updateFooter();
            applyStyles();
        }

        async function exportAsImage(format) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';
            
            await new Promise(r => setTimeout(r, 800)); // ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå

            const captureArea = document.getElementById('captureArea');
            try {
                const canvas = await html2canvas(captureArea, {
                    scale: 3, 
                    useCORS: true,
                    backgroundColor: "#ffffff",
                    onclone: (doc) => {
                        const clonedArea = doc.getElementById('captureArea');
                        clonedArea.style.width = '1200px'; 
                        const sticky = doc.querySelectorAll('.table-sticky-column');
                        sticky.forEach(s => s.style.position = 'static');
                    }
                });

                const link = document.createElement('a');
                link.download = `Car-Promotion-${Date.now()}.${format}`;
                link.href = canvas.toDataURL(`image/${format === 'png' ? 'png' : 'jpeg'}`, 0.95);
                link.click();
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
            } finally {
                overlay.style.display = 'none';
            }
        }

        function handleFileSelect(e, targetId) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    document.getElementById(targetId).src = ev.target.result;
                    setTimeout(renderTable, 100);
                };
                reader.readAsDataURL(file);
            }
        }

        function updateBannerColor(val) {
            document.getElementById('tableBanner').style.backgroundColor = val;
        }

        function renderMasterRates() {
            const body = document.getElementById('masterInterestBody');
            body.innerHTML = '';
            downTiers.forEach(tier => {
                let rowHTML = `<td class="py-1 font-bold text-slate-400 pr-2">${tier}%</td>`;
                terms.forEach(term => {
                    const key = `${tier}_${term}`;
                    rowHTML += `<td class="text-center"><input type="number" step="0.01" value="${masterRates[key]}" oninput="masterRates['${key}']=parseFloat(this.value||0); renderTable();"></td>`;
                });
                const tr = document.createElement('tr');
                tr.innerHTML = rowHTML;
                body.appendChild(tr);
            });
        }

        function renderInputs() {
            const grid = document.getElementById('inputGrid');
            grid.innerHTML = '';
            for(let i=0; i<activeCount; i++) {
                const car = cars[i];
                const card = document.createElement('div');
                card.className = "bg-white p-3 rounded-xl border border-slate-200 h-fit shadow-sm";
                card.innerHTML = `
                    <div class="mb-1"><span class="config-label">‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ #${i+1}</span><input type="text" value="${car.model}" oninput="updateCar(${i}, 'model', this.value)" class="w-full text-xs font-bold border-b pb-1 outline-none"></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div><span class="config-label">‡∏£‡∏≤‡∏Ñ‡∏≤</span><input type="number" value="${car.price}" oninput="updateCar(${i}, 'price', this.value)" class="w-full text-xs p-1 bg-slate-50 rounded"></div>
                        <div><span class="config-label">‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á (‡∏á‡∏ß‡∏î)</span><input type="text" value="${car.downPercents}" oninput="updateCar(${i}, 'downPercents', this.value)" class="w-full text-xs p-1 bg-slate-50 rounded" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15, 25"></div>
                    </div>
                `;
                grid.appendChild(card);
            }
        }

        function applyStyles() {
            const bannerHeight = document.getElementById('sizeBannerHeight').value;
            document.getElementById('tableBanner').style.height = bannerHeight + 'px';
            document.getElementById('displayModel').style.fontSize = (bannerHeight / 5) + 'px';

            const avatar = document.getElementById('sellerAvatar');
            const avatarSize = document.getElementById('sizeAvatar').value + 'px';
            avatar.style.width = avatarSize;
            avatar.style.height = avatarSize;

            const carX = document.getElementById('posCarX').value + '%';
            document.getElementById('carPreview').style.objectPosition = `${carX} center`;

            const avatarY = document.getElementById('posAvatarY').value + '%';
            avatar.style.objectPosition = `center ${avatarY}`;
        }

        function renderTable() {
            const head = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            const sizeH = document.getElementById('sizeTableHead').value + 'px';
            const sizeD = document.getElementById('sizeTableData').value + 'px';

            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            let headHTML = `<tr class="bg-slate-800 text-white" style="font-size: ${sizeH}">
                <th class="p-4 border-r w-[240px]">‡∏£‡∏∏‡πà‡∏ô‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</th>
                <th class="p-4 border-r w-[120px]">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                <th class="p-4 border-r w-[70px]">‡∏î‡∏≤‡∏ß‡∏ô‡πå</th>
                <th class="p-4 border-r w-[110px]">‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå</th>
                <th class="p-4 border-r w-[110px]">‡∏¢‡∏≠‡∏î‡∏à‡∏±‡∏î</th>`;
            terms.forEach(t => headHTML += `<th class="p-4 border-r">${t} ‡∏á‡∏ß‡∏î</th>`);
            head.innerHTML = headHTML + '</tr>';

            body.innerHTML = '';
            for(let i=0; i<activeCount; i++) {
                const car = cars[i];
                const downList = car.downPercents.split(',').map(d => parseFloat(d.trim())).filter(d => !isNaN(d));
                downList.forEach((downP, index) => {
                    const downAmt = car.price * (downP / 100);
                    const loanAmt = car.price - downAmt;
                    const tr = document.createElement('tr');
                    tr.style.fontSize = sizeD;
                    
                    let html = index === 0 ? `<td class="p-4 table-sticky-column border-r align-top bg-white font-bold" rowspan="${downList.length}">${car.model}</td><td class="p-4 text-right font-bold align-top bg-white border-r" rowspan="${downList.length}">${formatCurrency(car.price)}</td>` : '';
                    
                    html += `<td class="p-3 text-center text-slate-400 font-bold border-r">${downP}%</td>
                             <td class="p-3 text-right text-slate-500 border-r">${formatCurrency(downAmt)}</td>
                             <td class="p-3 text-right font-bold border-r text-blue-600 bg-blue-50/20">${formatCurrency(loanAmt)}</td>`;
                    
                    terms.forEach(t => {
                        // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        const rateTier = [...downTiers].reverse().find(tier => downP >= tier) || 0;
                        const rate = masterRates[`${rateTier}_${t}`] || 0;
                        const monthly = (loanAmt + (loanAmt * (rate/100) * (t/12))) / t;
                        html += `<td class="p-3 text-right font-extrabold text-slate-900 border-r">${formatCurrency(monthly)}</td>`;
                    });
                    
                    tr.innerHTML = html;
                    body.appendChild(tr);
                });
            }
        }

        function updateCar(idx, field, val) {
            cars[idx][field] = (field === 'model' || field === 'downPercents') ? val : parseFloat(val || 0);
            renderTable();
        }
        function updateFooter() {
            document.getElementById('displaySellerName').innerText = document.getElementById('inputSellerName').value;
            document.getElementById('displaySellerPhone').innerText = document.getElementById('inputSellerPhone').value;
            document.getElementById('displaySellerLine').innerText = document.getElementById('inputSellerLine').value;
            document.getElementById('displayDisclaimer').innerText = document.getElementById('inputDisclaimer').value;
        }
        function formatCurrency(n) { return new Intl.NumberFormat('th-TH').format(Math.round(n)); }
        window.onload = init;
        document.getElementById('carCountSelect').onchange = (e) => { activeCount = parseInt(e.target.value); renderInputs(); renderTable(); };
    </script>
</body>
</html>

